const zxCommon = require('./zx_common.js');
let zxObject = new zxCommon.ZxObject('‰∫¨‰∏úÂ§öÂêà‰∏ÄÁ≠æÂà∞');
const $ = zxObject.$;

const exec = require('child_process').execSync
const fs = require('fs')
const download = require('download');
let resultPath = "./result.txt";
let JD_DailyBonusPath = "./JD_DailyBonus.js";
let outPutUrl = './';
let NodeSet = 'CookieSet.json';
let allMessage = '';

!(async() => {
    if (!$.cookiesArr[0]) {
        $.msg($.name, '„ÄêÊèêÁ§∫„ÄëËØ∑ÂÖàËé∑Âèñcookie\nÁõ¥Êé•‰ΩøÁî®NobyDaÁöÑ‰∫¨‰∏úÁ≠æÂà∞Ëé∑Âèñ', 'https://bean.m.jd.com/bean/signIndex.action', { "open-url": "https://bean.m.jd.com/bean/signIndex.action" });
        return;
    }
    process.env.JD_BEAN_SIGN_NOTIFY_SIMPLE = process.env.JD_BEAN_SIGN_NOTIFY_SIMPLE ? process.env.JD_BEAN_SIGN_NOTIFY_SIMPLE : 'true';
    await requireConfig();
    // ‰∏ãËΩΩÊúÄÊñ∞‰ª£Á†Å
    await downFile();
    if (!await fs.existsSync(JD_DailyBonusPath)) {
        console.log(`\nJD_DailyBonus.js Êñá‰ª∂‰∏çÂ≠òÂú®ÔºåÂÅúÊ≠¢ÊâßË°å${$.name}\n`);
        await $.notify.sendNotify($.name, `Êú¨Ê¨°ÊâßË°å${$.name}Â§±Ë¥•ÔºåJD_DailyBonus.js Êñá‰ª∂‰∏ãËΩΩÂºÇÂ∏∏ÔºåËØ¶ÊÉÖËØ∑Êü•ÁúãÊó•Âøó`)
        return
    }
    const content = await fs.readFileSync(JD_DailyBonusPath, 'utf8')

    await $.dowork(async function() {
            console.log(`*****************ÂºÄÂßã‰∫¨‰∏úË¥¶Âè∑${$.index} ${$.nickName || $.UserName}‰∫¨Ë±ÜÁ≠æÂà∞*******************\n`);
            await changeFile(content);
            await execSign();
        })
        //await deleteFile(JD_DailyBonusPath);//Âà†Èô§‰∏ãËΩΩÁöÑJD_DailyBonus.jsÊñá‰ª∂
    if ($.isNode() && allMessage && process.env.JD_BEAN_SIGN_NOTIFY_SIMPLE === 'true') {
        $.msg($.name, '', allMessage);
        await $.notify.sendNotify($.name, allMessage)
    }

    //await deleteFile(JD_DailyBonusPath);//Âà†Èô§‰∏ãËΩΩÁöÑJD_DailyBonus.jsÊñá‰ª∂
    if ($.isNode() && allMessage && process.env.JD_BEAN_SIGN_NOTIFY_SIMPLE === 'true') {
        $.msg($.name, '', allMessage);
        await $.notify.sendNotify($.name, allMessage)
    }
})()
.catch((e) => $.logErr(e))
    .finally(() => $.done())
async function execSign() {
    console.log(`\nÂºÄÂßãÊâßË°å ${$.name} Á≠æÂà∞ÔºåËØ∑Á®çÁ≠â...\n`);
    try {
        // if ($.notify.SCKEY || $.notify.BARK_PUSH || $.notify.DD_BOT_TOKEN || ($.notify.TG_BOT_TOKEN && $.notify.TG_USER_ID) || $.notify.IGOT_PUSH_KEY || $.notify.QQ_SKEY) {
        //   await exec(`${process.execPath} ${JD_DailyBonusPath} >> ${resultPath}`);
        //   const notifyContent = await fs.readFileSync(resultPath, "utf8");
        //   console.log(`üëáüëáüëáüëáüëáüëáüëáüëáüëáüëáüëáLOGËÆ∞ÂΩïüëáüëáüëáüëáüëáüëáüëáüëáüëáüëáüëá\n${notifyContent}\nüëÜüëÜüëÜüëÜüëÜüëÜüëÜüëÜüëÜLOGËÆ∞ÂΩïüëÜüëÜüëÜüëÜüëÜüëÜüëÜüëÜüëÜüëÜüëÜ`);
        // } else {
        //   console.log('Ê≤°ÊúâÊèê‰æõÈÄöÁü•Êé®ÈÄÅÔºåÂàôÊâìÂç∞ËÑöÊú¨ÊâßË°åÊó•Âøó')
        //   await exec(`${process.execPath} ${JD_DailyBonusPath}`, { stdio: "inherit" });
        // }
        await exec(`${process.execPath} ${JD_DailyBonusPath} >> ${resultPath}`);
        const notifyContent = await fs.readFileSync(resultPath, "utf8");
        console.error(`üëáüëáüëáüëáüëáüëáüëáüëáüëáüëáüëáÁ≠æÂà∞ËØ¶ÊÉÖüëáüëáüëáüëáüëáüëáüëáüëáüëáüëáüëá\n${notifyContent}\nüëÜüëÜüëÜüëÜüëÜüëÜüëÜüëÜüëÜÁ≠æÂà∞ËØ¶ÊÉÖüëÜüëÜüëÜüëÜüëÜüëÜüëÜüëÜüëÜüëÜüëÜ`);
        // await exec("node JD_DailyBonus.js", { stdio: "inherit" });
        // console.log('ÊâßË°åÂÆåÊØï', new Date(new Date().getTime() + 8 * 3600000).toLocaleDateString())
        //ÂèëÈÄÅÈÄöÁü•
        let BarkContent = '';
        if (fs.existsSync(resultPath)) {
            const barkContentStart = notifyContent.indexOf('„ÄêÁ≠æÂà∞Ê¶ÇËßà„Äë')
            const barkContentEnd = notifyContent.length;
            if (process.env.JD_BEAN_SIGN_STOP_NOTIFY !== 'true') {
                if (process.env.JD_BEAN_SIGN_NOTIFY_SIMPLE === 'true') {
                    if (barkContentStart > -1 && barkContentEnd > -1) {
                        BarkContent = notifyContent.substring(barkContentStart, barkContentEnd);
                    }
                    BarkContent = BarkContent.split('\n\n')[0];
                } else {
                    if (barkContentStart > -1 && barkContentEnd > -1) {
                        BarkContent = notifyContent.substring(barkContentStart, barkContentEnd);
                    }
                }
            }
        }
        //‰∏çÁÆ°Âì™‰∏™Êó∂Âå∫,ËøôÈáåÂæóÂà∞ÁöÑÈÉΩÊòØÂåó‰∫¨Êó∂Èó¥ÁöÑÊó∂Èó¥Êà≥;
        const UTC8 = new Date().getTime() + new Date().getTimezoneOffset() * 60000 + 28800000;
        $.beanSignTime = new Date(UTC8).toLocaleString('zh', { hour12: false });
        //console.log(`ËÑöÊú¨ÊâßË°åÂÆåÊØïÊó∂Èó¥Ôºö${$.beanSignTime}`)
        if (BarkContent) {
            allMessage += `„Äê‰∫¨‰∏úÂè∑ ${$.index}„Äë: ${$.nickName || $.UserName}\n„ÄêÁ≠æÂà∞Êó∂Èó¥„Äë:  ${$.beanSignTime}\n${BarkContent}${$.index !== $.cookiesArr.length ? '\n\n' : ''}`;
            if (!process.env.JD_BEAN_SIGN_NOTIFY_SIMPLE || (process.env.JD_BEAN_SIGN_NOTIFY_SIMPLE && process.env.JD_BEAN_SIGN_NOTIFY_SIMPLE !== 'true')) {
                await $.notify.sendNotify(`${$.name} - Ë¥¶Âè∑${$.index} - ${$.nickName || $.UserName}`, `„ÄêÁ≠æÂà∞Âè∑ ${$.index}„Äë: ${$.nickName || $.UserName}\n„ÄêÁ≠æÂà∞Êó∂Èó¥„Äë:  ${$.beanSignTime}\n${BarkContent}`);
            }
        }
        //ËøêË°åÂÆåÊàêÂêéÔºåÂà†Èô§‰∏ãËΩΩÁöÑÊñá‰ª∂
        await deleteFile(resultPath); //Âà†Èô§result.txt
        console.log(`\n\n*****************${new Date(new Date().getTime()).toLocaleString('zh', {hour12: false})} ‰∫¨‰∏úË¥¶Âè∑${$.index} ${$.nickName || $.UserName} ${$.name}ÂÆåÊàê*******************\n\n`);
    } catch (e) {
        console.log("‰∫¨‰∏úÁ≠æÂà∞ËÑöÊú¨ÊâßË°åÂºÇÂ∏∏:" + e);
    }
}
async function downFile() {
    let url = '';
    await downloadUrl();
    if ($.body) {
        url = 'https://raw.githubusercontent.com/NobyDa/Script/master/JD-DailyBonus/JD_DailyBonus.js';
    } else {
        url = 'https://cdn.jsdelivr.net/gh/NobyDa/Script@master/JD-DailyBonus/JD_DailyBonus.js';
    }
    try {
        const options = {}
        if (process.env.TG_PROXY_HOST && process.env.TG_PROXY_PORT) {
            const tunnel = require("tunnel");
            const agent = {
                https: tunnel.httpsOverHttp({
                    proxy: {
                        host: process.env.TG_PROXY_HOST,
                        port: process.env.TG_PROXY_PORT * 1
                    }
                })
            }
            Object.assign(options, { agent })
        }
        await download(url, outPutUrl, options);
        console.log(`JD_DailyBonus.jsÊñá‰ª∂‰∏ãËΩΩÂÆåÊØï\n\n`);
    } catch (e) {
        console.log("JD_DailyBonus.js Êñá‰ª∂‰∏ãËΩΩÂºÇÂ∏∏:" + e);
    }
}

async function changeFile(content) {
    console.log(`ÂºÄÂßãÊõøÊç¢ÂèòÈáè`)
    //let newContent = content.replace(/var Key = '.*'/, `var Key = '${$.cookie}'`);
    let newContent = content.replace(/var OtherKey = ``/, `var OtherKey = '[{"cookie": "${$.cookie}"},
    "jrBody": "reqData=xxx"]'`);
    newContent = newContent.replace(/const NodeSet = 'CookieSet.json'/, `const NodeSet = '${NodeSet}'`)
    if (process.env.JD_BEAN_STOP && process.env.JD_BEAN_STOP !== '0') {
        newContent = newContent.replace(/var stop = '0'/, `var stop = '${process.env.JD_BEAN_STOP}'`);
    }
    const zone = new Date().getTimezoneOffset();
    if (zone === 0) {
        //Ê≠§Â§ÑÈíàÂØπUTC-0Êó∂Âå∫Áî®Êà∑ÂÅöÁöÑ
        newContent = newContent.replace(/tm\s=.*/, `tm = new Date(new Date().toLocaleDateString()).getTime() - 28800000;`);
    }
    try {
        await fs.writeFileSync(JD_DailyBonusPath, newContent, 'utf8');
        console.log('ÊõøÊç¢ÂèòÈáèÂÆåÊØï');
    } catch (e) {
        console.log("‰∫¨‰∏úÁ≠æÂà∞ÂÜôÂÖ•Êñá‰ª∂ÂºÇÂ∏∏:" + e);
    }
}
async function deleteFile(path) {
    // Êü•ÁúãÊñá‰ª∂result.txtÊòØÂê¶Â≠òÂú®,Â¶ÇÊûúÂ≠òÂú®,ÂÖàÂà†Èô§
    const fileExists = await fs.existsSync(path);
    // console.log('fileExists', fileExists);
    if (fileExists) {
        const unlinkRes = await fs.unlinkSync(path);
        // console.log('unlinkRes', unlinkRes)
    }
}

function downloadUrl(url = 'https://raw.githubusercontent.com/NobyDa/Script/master/JD-DailyBonus/JD_DailyBonus.js') {
    return new Promise(resolve => {
        const options = { url, "timeout": 10000 };
        if ($.isNode() && process.env.TG_PROXY_HOST && process.env.TG_PROXY_PORT) {
            const tunnel = require("tunnel");
            const agent = {
                https: tunnel.httpsOverHttp({
                    proxy: {
                        host: process.env.TG_PROXY_HOST,
                        port: process.env.TG_PROXY_PORT * 1
                    }
                })
            }
            Object.assign(options, { agent })
        }
        $.get(options, async(err, resp, data) => {
            try {
                if (err) {
                    // console.log(`${JSON.stringify(err)}`)
                    console.log(`Ê£ÄÊµãÂà∞ÊÇ®ÂΩìÂâçÁΩëÁªúÁéØÂ¢É‰∏çËÉΩËÆøÈóÆÂ§ñÁΩë,Â∞Ü‰ΩøÁî®jsdelivr CDN‰∏ãËΩΩJD_DailyBonus.jsÊñá‰ª∂`);
                    await $.http.get({ url: `https://purge.jsdelivr.net/gh/NobyDa/Script@master/JD-DailyBonus/JD_DailyBonus.js`, timeout: 10000 }).then((resp) => {
                        if (resp.statusCode === 200) {
                            let { body } = resp;
                            body = JSON.parse(body);
                            if (body['success']) {
                                console.log(`JD_DailyBonus.jsÊñá‰ª∂  CDNÂà∑Êñ∞ÊàêÂäü`)
                            } else {
                                console.log(`JD_DailyBonus.jsÊñá‰ª∂ CDNÂà∑Êñ∞Â§±Ë¥•`)
                            }
                        }
                    });
                } else {
                    $.body = data;
                }
            } catch (e) {
                $.logErr(e, resp)
            } finally {
                resolve();
            }
        })
    })
}

function requireConfig() {
    return new Promise(resolve => {
        // const file = 'jd_bean_sign.js';
        // fs.access(file, fs.constants.W_OK, (err) => {
        //   resultPath = err ? '/tmp/result.txt' : resultPath;
        //   JD_DailyBonusPath = err ? '/tmp/JD_DailyBonus.js' : JD_DailyBonusPath;
        //   outPutUrl = err ? '/tmp/' : outPutUrl;
        //   NodeSet = err ? '/tmp/CookieSet.json' : NodeSet;
        //   resolve()
        // });
        //Âà§Êñ≠ÊòØÂê¶ÊòØ‰∫ëÂáΩÊï∞ÁéØÂ¢É„ÄÇÂéüÂáΩÊï∞Ë∑üÁõÆÂΩïÁõÆÂΩïÊ≤°ÊúâÂèØÂÜôÂÖ•ÊùÉÈôêÔºåÊñá‰ª∂Âè™ËÉΩÊîæÂà∞Ê†πÁõÆÂΩï‰∏ãËôöÊãüÁöÑ/temp/Êñá‰ª∂Â§πÔºàÂÖ∑ÊúâÂèØÂÜôÂÖ•ÊùÉÈôêÔºâ
        resultPath = process.env.TENCENTCLOUD_RUNENV === 'SCF' ? '/tmp/result.txt' : resultPath;
        JD_DailyBonusPath = process.env.TENCENTCLOUD_RUNENV === 'SCF' ? '/tmp/JD_DailyBonus.js' : JD_DailyBonusPath;
        outPutUrl = process.env.TENCENTCLOUD_RUNENV === 'SCF' ? '/tmp/' : outPutUrl;
        NodeSet = process.env.TENCENTCLOUD_RUNENV === 'SCF' ? '/tmp/CookieSet.json' : NodeSet;
        resolve()
    })
}